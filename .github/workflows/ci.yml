name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ§¹ Clean Build Cache
        run: flutter clean
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ” Verify Dependencies
        run: flutter pub deps
      
      - name: ğŸ” Check for Dependency Vulnerabilities
        run: |
          echo "Checking for outdated packages..."
          flutter pub outdated || true
      
      - name: âœ¨ Verify Code Formatting
        run: |
          echo "Checking Dart code formatting..."
          dart format --set-exit-if-changed .
      
      - name: ğŸ” Run Dart Analyzer
        run: |
          echo "Running static analysis..."
          flutter analyze || (echo "âš ï¸ Analysis found issues but continuing..." && exit 0)
      
      - name: ğŸ“Š Generate Analysis Report
        if: always()
        run: |
          echo "Generating detailed analysis report..."
          flutter analyze > analysis_report.txt 2>&1 || true
          
          # Check for actual errors (not just info/warnings)
          if grep -q "error â€¢" analysis_report.txt; then
            echo "âŒ Found errors in analysis"
            cat analysis_report.txt
            exit 1
          fi
      
      - name: ğŸ“¤ Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis_report.txt
          retention-days: 30

  # Job 2: Unit & Widget Tests
  test:
    name: Unit & Widget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ§ª Run Tests with Coverage
        run: |
          flutter test --coverage --reporter expanded
      
      - name: ğŸ“Š Generate Coverage Report
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html
      
      - name: ğŸ“¤ Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: ğŸ“ˆ Coverage Summary
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            lcov --summary coverage/lcov.info
          fi

  # Job 3: Build Android
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build Android APK (Debug)
        run: |
          flutter build apk --debug --verbose
      
      - name: ğŸ“Š APK Size Analysis
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "APK Size: $APK_SIZE"
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
      
      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # Job 4: Build iOS (macOS runner)
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    timeout-minutes: 30
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build iOS (No Codesign)
        run: |
          flutter build ios --debug --no-codesign --verbose
      
      - name: ğŸ“Š Build Summary
        run: |
          echo "iOS build completed successfully"

  # Job 5: Build Web
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build Web App
        run: |
          flutter build web --verbose
      
      - name: ğŸ“Š Build Size Analysis
        run: |
          WEB_SIZE=$(du -sh build/web | cut -f1)
          echo "Web Build Size: $WEB_SIZE"
          echo "WEB_SIZE=$WEB_SIZE" >> $GITHUB_ENV
      
      - name: ğŸ“¤ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

  # Job 6: Discord Notification
  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, test, build-android, build-ios, build-web]
    
    steps:
      - name: ğŸ“Š Determine Status
        id: status
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.build-android.result }}" == "success" ]] && \
             [[ "${{ needs.build-ios.result }}" == "success" ]] && \
             [[ "${{ needs.build-web.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¢ Send Discord Notification
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "${{ steps.status.outputs.emoji }} CI Pipeline - ${{ steps.status.outputs.status == 'success' && 'Success' || 'Failed' }}"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            **Author:** ${{ github.actor }}
            **Event:** ${{ github.event_name }}
            
            **Job Results:**
            â€¢ Code Quality: ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.code-quality.result }}
            â€¢ Tests: ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.test.result }}
            â€¢ Android Build: ${{ needs.build-android.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-android.result }}
            â€¢ iOS Build: ${{ needs.build-ios.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-ios.result }}
            â€¢ Web Build: ${{ needs.build-web.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-web.result }}
          embed-color: ${{ steps.status.outputs.color }}
          embed-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          embed-footer-text: "Smart Attendance CI/CD"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
