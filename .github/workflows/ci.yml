name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_builds:
        description: 'Run platform builds (Android, iOS, Web)'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üßπ Clean Build Cache
        run: flutter clean
      
      - name: üì¶ Install Dependencies
        run: flutter pub get
      
      - name: üîç Verify Dependencies
        run: flutter pub deps
      
      - name: üîê Check for Dependency Vulnerabilities
        run: |
          echo "Checking for outdated packages..."
          flutter pub outdated || true
      
      - name: ‚ú® Verify Code Formatting
        run: |
          echo "Checking Dart code formatting..."
          dart format --set-exit-if-changed .
      
      - name: üîé Run Dart Analyzer
        run: |
          echo "Running static analysis..."
          flutter analyze || (echo "‚ö†Ô∏è Analysis found issues but continuing..." && exit 0)
      
      - name: üìä Generate Analysis Report
        if: always()
        run: |
          echo "Generating detailed analysis report..."
          flutter analyze > analysis_report.txt 2>&1 || true
          
          # Check for actual errors (not just info/warnings)
          if grep -q "error ‚Ä¢" analysis_report.txt; then
            echo "‚ùå Found errors in analysis"
            cat analysis_report.txt
            exit 1
          fi
      
      - name: üì§ Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis_report.txt
          retention-days: 30

  # Job 2: Unit & Widget Tests
  test:
    name: Unit & Widget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Install Dependencies
        run: flutter pub get
      
      - name: üß™ Run Tests with Coverage
        run: |
          flutter test --coverage --reporter expanded
      
      - name: üìä Generate Coverage Report
        if: always()
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          if [ -f coverage/lcov.info ] && [ -s coverage/lcov.info ]; then
            genhtml coverage/lcov.info -o coverage/html
          else
            echo "No coverage data generated - skipping report generation"
          fi
      
      - name: üì§ Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: üìà Coverage Summary
        if: always()
        continue-on-error: true
        run: |
          if [ -f coverage/lcov.info ] && [ -s coverage/lcov.info ]; then
            lcov --summary coverage/lcov.info
          else
            echo "No coverage data available - tests passed but no code coverage generated"
          fi

  # Job 3: Build Android (Optional - only runs when manually triggered)
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: test
    if: github.event_name == 'workflow_dispatch' && inputs.run_builds == true
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: üì¶ Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: üîß Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Install Dependencies
        run: flutter pub get
      
      - name: ‚öôÔ∏è Configure Gradle
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
      
      - name: üèóÔ∏è Build Android APK (Debug)
        run: |
          flutter build apk --debug
      
      - name: üìä APK Size Analysis
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "APK Size: $APK_SIZE"
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
      
      - name: üì§ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # Job 4: Build iOS (Optional - only runs when manually triggered)
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'workflow_dispatch' && inputs.run_builds == true
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Install Dependencies
        run: flutter pub get
      
      - name: üèóÔ∏è Build iOS (No Codesign)
        run: |
          flutter build ios --debug --no-codesign
      
      - name: üìä Build Summary
        run: |
          echo "iOS build completed successfully"

  # Job 5: Build Web (Optional - only runs when manually triggered)
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    if: github.event_name == 'workflow_dispatch' && inputs.run_builds == true
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Install Dependencies
        run: flutter pub get
      
      - name: üèóÔ∏è Build Web App
        run: |
          flutter build web
      
      - name: üìä Build Size Analysis
        run: |
          WEB_SIZE=$(du -sh build/web | cut -f1)
          echo "Web Build Size: $WEB_SIZE"
          echo "WEB_SIZE=$WEB_SIZE" >> $GITHUB_ENV
      
      - name: üì§ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

  # Job 6: Discord Notification (Optional - only if webhook is configured)
  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, test, build-android, build-ios, build-web]
    
    steps:
      - name: üìä Determine Status
        id: status
        run: |
          # Check if builds were run
          BUILDS_RUN="${{ github.event_name == 'workflow_dispatch' && inputs.run_builds == true }}"
          
          # Always check code quality and tests
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]]; then
            
            # If builds were run, check them too
            if [[ "$BUILDS_RUN" == "true" ]]; then
              if [[ "${{ needs.build-android.result }}" == "success" ]] && \
                 [[ "${{ needs.build-ios.result }}" == "success" ]] && \
                 [[ "${{ needs.build-web.result }}" == "success" ]]; then
                echo "status=success" >> $GITHUB_OUTPUT
                echo "color=3066993" >> $GITHUB_OUTPUT
                echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
              else
                echo "status=failure" >> $GITHUB_OUTPUT
                echo "color=15158332" >> $GITHUB_OUTPUT
                echo "emoji=‚ùå" >> $GITHUB_OUTPUT
              fi
            else
              # Builds skipped, only code quality and tests matter
              echo "status=success" >> $GITHUB_OUTPUT
              echo "color=3066993" >> $GITHUB_OUTPUT
              echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          fi
      
      - name: üì¢ Send Discord Notification
        if: env.DISCORD_WEBHOOK_URL != ''
        uses: tsickert/discord-webhook@v6.0.0
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "${{ steps.status.outputs.emoji }} CI Pipeline - ${{ steps.status.outputs.status == 'success' && 'Success' || 'Failed' }}"
          embed-description: |-
            **Repository:** ${{ github.repository }}
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            **Author:** ${{ github.actor }}
            **Event:** ${{ github.event_name }}
            
            **Job Results:**
            ‚Ä¢ Code Quality: ${{ needs.code-quality.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.code-quality.result }}
            ‚Ä¢ Tests: ${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.test.result }}
            ${{ github.event_name == 'workflow_dispatch' && inputs.run_builds == true && format('‚Ä¢ Android Build: {0} {1}', needs.build-android.result == 'success' && '‚úÖ' || '‚ùå', needs.build-android.result) || '‚Ä¢ Builds: ‚è≠Ô∏è skipped' }}
            ${{ github.event_name == 'workflow_dispatch' && inputs.run_builds == true && format('‚Ä¢ iOS Build: {0} {1}', needs.build-ios.result == 'success' && '‚úÖ' || '‚ùå', needs.build-ios.result) || '' }}
            ${{ github.event_name == 'workflow_dispatch' && inputs.run_builds == true && format('‚Ä¢ Web Build: {0} {1}', needs.build-web.result == 'success' && '‚úÖ' || '‚ùå', needs.build-web.result) || '' }}
          embed-color: ${{ steps.status.outputs.color }}
          embed-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          embed-footer-text: "Smart Attendance CI/CD"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
