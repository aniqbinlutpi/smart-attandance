name: CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # Job 1: Create Release Build
  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build Android APK (Release)
        run: |
          flutter build apk --release --verbose
      
      - name: ğŸ—ï¸ Build Android App Bundle (Release)
        run: |
          flutter build appbundle --release --verbose
      
      - name: ğŸ“Š Build Size Analysis
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
          echo "APK Size: $APK_SIZE"
          echo "AAB Size: $AAB_SIZE"
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
          echo "AAB_SIZE=$AAB_SIZE" >> $GITHUB_ENV
      
      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90
      
      - name: ğŸ“¤ Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90

  # Job 2: Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release
          path: ./release
      
      - name: ğŸ“¥ Download App Bundle
        uses: actions/download-artifact@v4
        with:
          name: android-aab-release
          path: ./release
      
      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Smart Attendance Release ${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ What's Included
          - Android APK (Universal)
          - Android App Bundle (for Play Store)
          
          ### ğŸ“Š Build Information
          - Flutter Version: ${{ env.FLUTTER_VERSION }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Commit: ${{ github.sha }}
          
          ### ğŸ“¥ Installation
          Download the APK file and install it on your Android device.
          
          ### ğŸ” Security
          All builds are created through our automated CI/CD pipeline and are signed.
          EOF
      
      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ./release/app-release.apk
            ./release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: Discord Notification
  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [build-release, create-release]
    
    steps:
      - name: ğŸ“Š Determine Status
        id: status
        run: |
          if [[ "${{ needs.build-release.result }}" == "success" ]] && \
             [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT
            echo "emoji=ğŸš€" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¢ Send Discord Notification
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "${{ steps.status.outputs.emoji }} Release ${{ steps.version.outputs.version }} - ${{ steps.status.outputs.status == 'success' && 'Published' || 'Failed' }}"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Version:** `${{ steps.version.outputs.version }}`
            **Commit:** `${{ github.sha }}`
            **Author:** ${{ github.actor }}
            
            **Build Results:**
            â€¢ Release Build: ${{ needs.build-release.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-release.result }}
            â€¢ GitHub Release: ${{ needs.create-release.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.create-release.result }}
            
            ${{ steps.status.outputs.status == 'success' && '**Download:** [View Release](' || '' }}${{ steps.status.outputs.status == 'success' && github.server_url || '' }}${{ steps.status.outputs.status == 'success' && '/' || '' }}${{ steps.status.outputs.status == 'success' && github.repository || '' }}${{ steps.status.outputs.status == 'success' && '/releases/tag/' || '' }}${{ steps.status.outputs.status == 'success' && steps.version.outputs.version || '' }}${{ steps.status.outputs.status == 'success' && ')' || '' }}
          embed-color: ${{ steps.status.outputs.color }}
          embed-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          embed-footer-text: "Smart Attendance CD Pipeline"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
